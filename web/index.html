<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π</title>

  <script>
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ —Ç–µ–º—ã –≤ localStorage –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é
    const userTheme = localStorage.getItem('theme');
    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const theme = userTheme || systemTheme;
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dark {
      background-color: #111827;
      color: #e5e7eb;
    }

    .dark .bg-white {
      background-color: #1f2937 !important;
    }

    .dark .text-gray-800 {
      color: #f9fafb !important;
    }

    .dark .text-gray-600 {
      color: #d1d5db !important;
    }

    .dark .bg-gray-50 {
      background-color: #374151 !important;
    }

    .dark input,
    .dark textarea {
      background-color: #374151;
      border-color: #4b5563;
      color: #f9fafb;
    }
  </style>
</head>

<body class="min-h-screen p-8">
  <div id="app" class="w-full max-w-md mx-auto p-4">
    <div id="setup-screen" class="hidden">
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold text-gray-800 mb-4">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å</h2>
        <input id="setup-pass" type="password" placeholder="–ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å" class="w-full p-2 border rounded mb-3">
        <button onclick="setupVault()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
          –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        </button>
        <p id="setup-msg" class="mt-2 text-sm text-red-600"></p>
      </div>
    </div>

    <div id="login-screen" class="hidden">
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold text-gray-800 mb-4">–í—Ö–æ–¥</h2>
        <input id="login-pass" type="password" placeholder="–ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å" class="w-full p-2 border rounded mb-3">
        <button onclick="login()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          –í–æ–π—Ç–∏
        </button>
        <p id="login-msg" class="mt-2 text-sm text-red-600"></p>
      </div>
    </div>

    <div id="main-screen" class="hidden">
      <div class="bg-white p-6 rounded shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
          <button onclick="logout()" class="text-red-600 text-sm">–í—ã–π—Ç–∏</button>
          <button onclick="toggleTheme()" class="ml-2 text-sm text-blue-400">üåì</button>
        </div>


        <div class="mb-6 p-4 border rounded bg-gray-50">
          <h3 class="font-medium mb-2">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
          <input id="new-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub)" class="w-full p-2 border rounded mb-2">
          <input id="new-url" placeholder="–°–∞–π—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="w-full p-2 border rounded mb-2">
          <input id="new-username" placeholder="–õ–æ–≥–∏–Ω" class="w-full p-2 border rounded mb-2">
          <input id="new-password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-2 border rounded mb-2">
          <textarea id="new-notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
            class="w-full p-2 border rounded mb-2"></textarea>
          <button onclick="addEntry()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
          <p id="add-msg" class="mt-2 text-sm text-red-600"></p>
        </div>


        <div id="entries-list" class="space-y-3">

        </div>
      </div>
    </div>
  </div>

  <script>
    let sessionId = localStorage.getItem('session_id');
    const masterPassword = null;

    async function api(url, method, body) {
      const headers = { 'Content-Type': 'application/json' };
      if (sessionId) headers['X-Session-ID'] = sessionId;
      const res = await fetch(url, {
        method,
        headers,
        body: body ? JSON.stringify(body) : null
      });
      return await res.json();
    }

    async function getMasterPassword() {
      return prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:");
    }

    async function loadEntries() {
      const pass = await getMasterPassword();
      if (!pass) return;

      const res = await api('/api/v1/entries/list', 'POST', { password: pass });
      if (res.error) {
        alert('–û—à–∏–±–∫–∞: ' + res.error);
        return;
      }

      const list = document.getElementById('entries-list');
      list.innerHTML = '';
      if (res.entries.length === 0) {
        list.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
      }

      res.entries.forEach(e => {
        const div = document.createElement('div');
        div.className = 'p-3 border rounded bg-gray-50';
        div.innerHTML = `
        <div class="font-bold">${e.title}</div>
        <div>–õ–æ–≥–∏–Ω: ${e.username}</div>
        <div>–ü–∞—Ä–æ–ª—å: <span class="font-mono">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span> 
          <button onclick="showPassword('${e.password}')" class="text-blue-600 text-sm">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        ${e.url ? `<div>–°–∞–π—Ç: <a href="${e.url}" target="_blank" class="text-blue-600">${e.url}</a></div>` : ''}
        ${e.notes ? `<div class="text-sm text-gray-600 mt-1">–ó–∞–º–µ—Ç–∫–∏: ${e.notes}</div>` : ''}
      `;
        list.appendChild(div);
      });
    }

    async function addEntry() {
      const title = document.getElementById('new-title').value;
      if (!title) { alert('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }

      const pass = await getMasterPassword();
      if (!pass) return;

      const entry = {
        title: title,
        url: document.getElementById('new-url').value,
        username: document.getElementById('new-username').value,
        password: document.getElementById('new-password').value,
        notes: document.getElementById('new-notes').value,
      };

      const res = await api('/api/v1/entries', 'POST', {
        password: pass,
        entry: entry
      });

      if (res.success) {
        document.getElementById('add-msg').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
        setTimeout(() => document.getElementById('add-msg').textContent = '', 2000);
        document.getElementById('new-title').value = '';
        document.getElementById('new-url').value = '';
        document.getElementById('new-username').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('new-notes').value = '';
        loadEntries();
      } else {
        document.getElementById('add-msg').textContent = res.error || '–û—à–∏–±–∫–∞';
      }
    }

    async function checkVaultStatus() {
      const setupScreen = document.getElementById('setup-screen');
      const loginScreen = document.getElementById('login-screen');

      try {
        const hashRequest = await fetch('/vault/meta.json');
        if (hashRequest.status === 404) throw new Error('vault not init');

        const hash = await hashRequest.text()
        if (hash.trim() === '') throw new Error('vault not init');

        loginScreen.classList.remove('hidden');
      } catch (e) {
        setupScreen.classList.remove('hidden');
      }
    }

    async function setupVault() {
      const pass = document.getElementById('setup-pass').value;
      const msg = document.getElementById('setup-msg');
      if (!pass) return;
      const res = await api('/api/v1/setup', 'POST', { password: pass });
      if (res.success) {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        msg.textContent = '';
      } else {
        msg.textContent = res.error || '–û—à–∏–±–∫–∞';
      }
    }

    async function login() {
      const pass = document.getElementById('login-pass').value;
      const msg = document.getElementById('login-msg');
      if (!pass) return;
      const res = await api('/api/v1/login', 'POST', { password: pass });
      if (res.success) {
        sessionId = res.session_id;
        localStorage.setItem('session_id', sessionId);
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        msg.textContent = '';
      } else {
        msg.textContent = res.error || '–û—à–∏–±–∫–∞';
      }
    }

    function showPassword(password) {
      alert('–ü–∞—Ä–æ–ª—å: ' + password);
    }

    function logout() {
      sessionId = null;
      localStorage.removeItem('session_id');
      window.location.reload();
    }

    function toggleTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      const newTheme = isDark ? 'light' : 'dark';

      if (newTheme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      localStorage.setItem('theme', newTheme);
    }

    if (sessionId) {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      loadEntries();
    } else {
      checkVaultStatus();
    }
  </script>
</body>

</html>